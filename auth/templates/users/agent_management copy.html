{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Management</title>
    <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}">
    <link rel="stylesheet" href="{% static 'css/agent_management.css' %}">
</head>
<body>
    <main class="agentManagementPage">
        <div class="agentManagementContainer">
            <div class="header">
                <h1>Agent Management</h1>
                <div class="headerActions">
                    <a href="{% url 'profile-settings' %}" class="btn btnSecondary">My Profile</a>
                    <a href="/logout/" class="btn btnDanger">Logout</a>
                </div>
            </div>

            <!-- Toast Messages -->
            <div id="toast-container" class="toastContainer hidden"></div>
            
            <!-- Loading Spinner -->
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Loading agents...</p>
            </div>

            <!-- Error Display -->
            <div id="error-container" class="errorContainer hidden">
                <p id="error-message"></p>
                <button onclick="loadAgents()" class="btn btnPrimary">Retry</button>
            </div>

            <!-- Agents List -->
            <div id="agents-container" class="agentsContainer">
                <div class="agentsHeader">
                    <h2>System Agents</h2>
                    <div class="agentsStats">
                        <span id="agents-count">Loading...</span>
                    </div>
                </div>

                <div class="agentsGrid" id="agents-grid">
                    <!-- Agents will be loaded here dynamically -->
                </div>
            </div>
        </div>

        <!-- Edit Agent Modal -->
        <div id="edit-modal" class="modal hidden">
            <div class="modalContent">
                <div class="modalHeader">
                    <h3>Edit Agent</h3>
                    <button onclick="closeEditModal()" class="modalClose">&times;</button>
                </div>
                <form id="edit-form">
                    <div class="formGroup">
                        <label for="edit-username">Username</label>
                        <input type="text" id="edit-username" name="username" required>
                    </div>
                    <div class="formGroup">
                        <label for="edit-email">Email</label>
                        <input type="email" id="edit-email" name="email" required>
                    </div>
                    <div class="formGroup">
                        <label for="edit-first-name">First Name</label>
                        <input type="text" id="edit-first-name" name="first_name">
                    </div>
                    <div class="formGroup">
                        <label for="edit-last-name">Last Name</label>
                        <input type="text" id="edit-last-name" name="last_name">
                    </div>
                    <div class="formGroup">
                        <label for="edit-phone">Phone Number</label>
                        <input type="tel" id="edit-phone" name="phone_number">
                    </div>
                    <div class="formGroup">
                        <label for="edit-company">Company</label>
                        <input type="text" id="edit-company" name="company_name" readonly>
                        <small>Company cannot be changed</small>
                    </div>
                    <div class="formGroup">
                        <label for="edit-active">Status</label>
                        <select id="edit-active" name="is_active">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="modalActions">
                        <button type="button" onclick="closeEditModal()" class="btn btnSecondary">Cancel</button>
                        <button type="submit" class="btn btnPrimary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Agent Modal -->
        <div id="view-modal" class="modal hidden">
            <div class="modalContent">
                <div class="modalHeader">
                    <h3>Agent Details</h3>
                    <button onclick="closeViewModal()" class="modalClose">&times;</button>
                </div>
                <div class="agentDetails" id="agent-details">
                    <!-- Agent details will be loaded here -->
                </div>
                <div class="modalActions">
                    <button onclick="closeViewModal()" class="btn btnSecondary">Close</button>
                    <button onclick="editFromView()" class="btn btnPrimary">Edit Agent</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrfToken = getCookie('csrftoken');
        let currentAgentId = null;
        let agents = [];

        // Toast notification system
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            container.classList.remove('hidden');
            
            setTimeout(() => {
                toast.remove();
                if (container.children.length === 0) {
                    container.classList.add('hidden');
                }
            }, 5000);
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('agents-container').classList.add('hidden');
            document.getElementById('error-container').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Show error
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').classList.remove('hidden');
            document.getElementById('agents-container').classList.add('hidden');
            hideLoading();
        }

        // Load agents from API
        async function loadAgents() {
            showLoading();
            
            try {
                const response = await fetch('/api/v1/users/list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                agents = data.users || [];
                
                displayAgents(agents);
                document.getElementById('agents-count').textContent = `${agents.length} agents found`;
                
                document.getElementById('agents-container').classList.remove('hidden');
                hideLoading();
                
            } catch (error) {
                console.error('Error loading agents:', error);
                showError('Failed to load agents. Please check your connection and try again.');
            }
        }

        // Display agents in the grid
        function displayAgents(agentsData) {
            const grid = document.getElementById('agents-grid');
            grid.innerHTML = '';

            if (agentsData.length === 0) {
                grid.innerHTML = '<div class="noAgents">No agents found.</div>';
                return;
            }

            agentsData.forEach(agent => {
                const agentCard = createAgentCard(agent);
                grid.appendChild(agentCard);
            });
        }

        // Create agent card HTML
        function createAgentCard(agent) {
            const card = document.createElement('div');
            card.className = 'agentCard';
            card.innerHTML = `
                <div class="agentHeader">
                    <div class="agentAvatar">
                        <img src="${agent.profile_picture || 'https://i.pinimg.com/1200x/a9/a8/c8/a9a8c8258957c8c7d6fcd320e9973203.jpg'}" 
                             alt="${agent.username}" />
                    </div>
                    <div class="agentInfo">
                        <h3>${agent.username}</h3>
                        <p class="agentEmail">${agent.email}</p>
                        <span class="agentStatus ${agent.is_active ? 'active' : 'inactive'}">
                            ${agent.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
                <div class="agentDetails">
                    <p><strong>Name:</strong> ${agent.first_name || ''} ${agent.last_name || ''}</p>
                    <p><strong>Company:</strong> ${agent.company_name || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${agent.phone_number || 'N/A'}</p>
                    <p><strong>Last Login:</strong> ${agent.last_login ? new Date(agent.last_login).toLocaleDateString() : 'Never'}</p>
                </div>
                <div class="agentActions">
                    <button onclick="viewAgent(${agent.id})" class="btn btnSecondary btnSmall">View</button>
                    <button onclick="editAgent(${agent.id})" class="btn btnPrimary btnSmall">Edit</button>
                </div>
            `;
            return card;
        }

        // View agent details
        async function viewAgent(agentId) {
            try {
                const response = await fetch(`/api/v1/users/${agentId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const agent = await response.json();
                currentAgentId = agentId;
                
                const detailsHtml = `
                    <div class="detailItem">
                        <label>Username:</label>
                        <span>${agent.username}</span>
                    </div>
                    <div class="detailItem">
                        <label>Email:</label>
                        <span>${agent.email}</span>
                    </div>
                    <div class="detailItem">
                        <label>First Name:</label>
                        <span>${agent.first_name || 'N/A'}</span>
                    </div>
                    <div class="detailItem">
                        <label>Last Name:</label>
                        <span>${agent.last_name || 'N/A'}</span>
                    </div>
                    <div class="detailItem">
                        <label>Phone:</label>
                        <span>${agent.phone_number || 'N/A'}</span>
                    </div>
                    <div class="detailItem">
                        <label>Company:</label>
                        <span>${agent.company_name || 'N/A'}</span>
                    </div>
                    <div class="detailItem">
                        <label>Status:</label>
                        <span class="agentStatus ${agent.is_active ? 'active' : 'inactive'}">
                            ${agent.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="detailItem">
                        <label>Date Joined:</label>
                        <span>${new Date(agent.date_joined).toLocaleDateString()}</span>
                    </div>
                    <div class="detailItem">
                        <label>Last Login:</label>
                        <span>${agent.last_login ? new Date(agent.last_login).toLocaleDateString() : 'Never'}</span>
                    </div>
                `;
                
                document.getElementById('agent-details').innerHTML = detailsHtml;
                document.getElementById('view-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading agent details:', error);
                showToast('Failed to load agent details', 'error');
            }
        }

        // Edit agent
        async function editAgent(agentId) {
            try {
                const response = await fetch(`/api/v1/users/${agentId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const agent = await response.json();
                currentAgentId = agentId;
                
                // Populate form
                document.getElementById('edit-username').value = agent.username || '';
                document.getElementById('edit-email').value = agent.email || '';
                document.getElementById('edit-first-name').value = agent.first_name || '';
                document.getElementById('edit-last-name').value = agent.last_name || '';
                document.getElementById('edit-phone').value = agent.phone_number || '';
                document.getElementById('edit-company').value = agent.company_name || '';
                document.getElementById('edit-active').value = agent.is_active ? 'true' : 'false';
                
                document.getElementById('edit-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading agent for edit:', error);
                showToast('Failed to load agent data for editing', 'error');
            }
        }

        // Edit from view modal
        function editFromView() {
            closeViewModal();
            editAgent(currentAgentId);
        }

        // Close modals
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            currentAgentId = null;
        }

        function closeViewModal() {
            document.getElementById('view-modal').classList.add('hidden');
            currentAgentId = null;
        }

        // Handle edit form submission
        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentAgentId) return;
            
            const formData = new FormData(this);
            const data = {
                username: formData.get('username'),
                email: formData.get('email'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                phone_number: formData.get('phone_number'),
                is_active: formData.get('is_active') === 'true'
            };
            
            try {
                const response = await fetch(`/api/v1/users/${currentAgentId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update agent');
                }

                const updatedAgent = await response.json();
                showToast('Agent updated successfully', 'success');
                closeEditModal();
                loadAgents(); // Refresh the list
                
            } catch (error) {
                console.error('Error updating agent:', error);
                showToast(error.message || 'Failed to update agent', 'error');
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            const editModal = document.getElementById('edit-modal');
            const viewModal = document.getElementById('view-modal');
            
            if (e.target === editModal) {
                closeEditModal();
            }
            if (e.target === viewModal) {
                closeViewModal();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAgents();
        });
    </script>
</body>
</html>
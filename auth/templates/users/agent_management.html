{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Management</title>
    <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}" />
    <link rel="stylesheet" href="{% static 'css/agent_management.css' %}" />
  </head>
  <body>
    <main class="agentManagementPage">
      <div class="agentManagementContainer">
        <div class="header">
          <h1>Agent Management</h1>
          <div class="headerActions">
            <a href="{% url 'profile-settings' %}" class="btn btnSecondary"
              >My Profile</a
            >
            <a href="/logout/" class="btn btnDanger">Logout</a>
          </div>
        </div>

        <!-- Toast Messages -->
        <div id="toast-container" class="toastContainer hidden"></div>

        <!-- Loading Spinner -->
        <div id="loading" class="loading hidden">
          <div class="spinner"></div>
          <p>Loading agents...</p>
        </div>

        <!-- Error Display -->
        <div id="error-container" class="errorContainer hidden">
          <p id="error-message"></p>
          <button onclick="loadAgents()" class="btn btnPrimary">Retry</button>
        </div>

        <!-- Agents List -->
        <div id="agents-container" class="agentsContainer">
          <div class="agentsHeader">
            <h2 id="agents-title">System Agents</h2>

            <div class="agentsSearch">
              <input
                type="search"
                id="search-input"
                placeholder="Search agents by role, email, name, company, or phone..."
              />
              <button id="clear-search" class="btn btnSecondary">Clear</button>
            </div>

            <!--<div class="agentsStats">
              <span id="agents-count">Loading...</span>
            </div>-->
          </div>

          <div class="ticketTableWrapper">
            <table id="agents-table" class="agentsTable">
              <thead>
                <tr>
                  <th>Avatar</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Company</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Last Login</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="agents-body">
                <!-- Agents will be loaded here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit Agent Modal -->
      <div id="edit-modal" class="modal hidden">
        <div class="modalContent">
          <div class="modalContentWrapper">
            <div class="modalHeader">
              <h3>Edit Agent</h3>
              <button onclick="closeEditModal()" class="modalClose">
                &times;
              </button>
            </div>
            <form id="edit-form">
              <div class="formGroup">
                <label for="edit-username">Username</label>
                <input
                  type="text"
                  id="edit-username"
                  name="username"
                  required
                />
              </div>
              <div class="formGroup">
                <label for="edit-email">Email</label>
                <input type="email" id="edit-email" name="email" required />
              </div>
              <div class="formGroup">
                <label for="edit-first-name">First Name</label>
                <input type="text" id="edit-first-name" name="first_name" />
              </div>
              <div class="formGroup">
                <label for="edit-last-name">Last Name</label>
                <input type="text" id="edit-last-name" name="last_name" />
              </div>
              <div class="formGroup">
                <label for="edit-phone">Phone Number</label>
                <input type="tel" id="edit-phone" name="phone_number" />
              </div>
              <div class="formGroup">
                <label for="edit-company">Company</label>
                <input
                  type="text"
                  id="edit-company"
                  name="company_name"
                  readonly
                />
                <small>Company cannot be changed</small>
              </div>
              <div class="formGroup">
                <label for="edit-active">Status</label>
                <select id="edit-active" name="is_active">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
              <div class="modalActions">
                <button
                  type="button"
                  onclick="closeEditModal()"
                  class="btn btnSecondary"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btnPrimary">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- View Agent Modal -->
      <div id="view-modal" class="modal hidden">
        <div class="modalContentWrapper">
          <div class="modalContent">
            <div class="modalHeader">
              <h3>Agent Details</h3>
              <button onclick="closeViewModal()" class="modalClose">
                &times;
              </button>
            </div>
            <div class="agentDetails" id="agent-details">
              <!-- Agent details will be loaded here -->
            </div>
            <div class="modalActions">
              <button onclick="closeViewModal()" class="btn btnSecondary">
                Close
              </button>
              <button onclick="editFromView()" class="btn btnPrimary">
                Edit Agent
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Get CSRF token from cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      const csrfToken = getCookie("csrftoken");
      let currentAgentId = null;
      let agents = [];

      // Toast notification system
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);
        container.classList.remove("hidden");

        setTimeout(() => {
          toast.remove();
          if (container.children.length === 0) {
            container.classList.add("hidden");
          }
        }, 5000);
      }

      // Show/hide loading
      function showLoading() {
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("agents-container").classList.add("hidden");
        document.getElementById("error-container").classList.add("hidden");
      }

      function hideLoading() {
        document.getElementById("loading").classList.add("hidden");
      }

      // Show error
      function showError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-container").classList.remove("hidden");
        document.getElementById("agents-container").classList.add("hidden");
        hideLoading();
      }

      // Load agents from API
      async function loadAgents() {
        showLoading();

        try {
          const response = await fetch("/api/v1/users/list/", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          agents = data.users || [];

          displayAgents(agents);
          const totalCount = agents.length;
          // Update both the H2 title and the small stats span
          const titleEl = document.getElementById("agents-title");
          const countEl = document.getElementById("agents-count");
          if (titleEl) titleEl.textContent = `System Agents (${totalCount})`;
          if (countEl) countEl.textContent = `${totalCount} agents found`;

          document
            .getElementById("agents-container")
            .classList.remove("hidden");
          hideLoading();
        } catch (error) {
          console.error("Error loading agents:", error);
          showError(
            "Failed to load agents. Please check your connection and try again."
          );
        }
      }

      // Display agents in table
      function displayAgents(agentsData) {
        const tableBody = document.getElementById("agents-body");
        tableBody.innerHTML = "";

        if (agentsData.length === 0) {
          tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="noAgents">No agents found.</td>
            </tr>`;
          return;
        }
        return cookieValue;
      }

      let currentUser = null; // Store current authenticated user info
      let currentSystemName = "System"; // Store current system name
      let currentSystemSlug = ""; // Store current system slug for filtering

      // Toast notification system
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);
        container.classList.remove("hidden");

        setTimeout(() => {
          toast.remove();
          if (container.children.length === 0) {
            container.classList.add("hidden");
          }
        }, 5000);
      }

      // Show/hide loading
      function showLoading() {
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("agents-container").classList.add("hidden");
        document.getElementById("error-container").classList.add("hidden");
      }

      function hideLoading() {
        document.getElementById("loading").classList.add("hidden");
      }

      // Show error
      function showError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-container").classList.remove("hidden");
        document.getElementById("agents-container").classList.add("hidden");
        hideLoading();
      }

      // Load agents from API
      async function loadAgents() {
        showLoading();

        try {
          // Fetch current user profile and agents list simultaneously
          const [profileResponse, agentsResponse] = await Promise.all([
            fetch("/api/v1/users/profile/", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              credentials: "include",
            }),
            fetch("/api/v1/users/list/", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              credentials: "include",
            })
          ]);

          if (!profileResponse.ok || !agentsResponse.ok) {
            throw new Error(`HTTP error! Profile: ${profileResponse.status}, Agents: ${agentsResponse.status}`);
          }

          const [profileData, agentsData] = await Promise.all([
            profileResponse.json(),
            agentsResponse.json()
          ]);

          currentUser = profileData;
          const allAgents = agentsData.users || [];
          
          // Debug: Log the profile data to see the structure
          console.log('Current user profile data:', currentUser);
          
          // Get the system name from the user's system_roles
          if (currentUser.system_roles && currentUser.system_roles.length > 0) {
            console.log('User system roles:', currentUser.system_roles);
            // Find the first admin role to get the system name
            const adminRole = currentUser.system_roles.find(role => role.role_name === 'Admin');
            if (adminRole && adminRole.system_name) {
              currentSystemName = adminRole.system_name;
              currentSystemSlug = adminRole.system_slug;
            } else if (currentUser.system_roles[0].system_name) {
              // Fallback to first system if no admin role found
              currentSystemName = currentUser.system_roles[0].system_name;
              currentSystemSlug = currentUser.system_roles[0].system_slug;
            }
          }
          
          console.log('Determined system name:', currentSystemName);
          
          // Filter out the current authenticated user from the agents list
          agents = allAgents.filter(agent => agent.id !== currentUser.id);

          displayAgents(agents);
          const totalCount = agents.length;
          // Update both the H2 title and the small stats span with system name
          const titleEl = document.getElementById("agents-title");
          const countEl = document.getElementById("agents-count");
          if (titleEl) titleEl.textContent = `${currentSystemName} Agents (${totalCount})`;
          if (countEl) countEl.textContent = `${totalCount} agents found`;

          document
            .getElementById("agents-container")
            .classList.remove("hidden");
          hideLoading();
        } catch (error) {
          console.error("Error loading agents:", error);
          showError(
            "Failed to load agents. Please check your connection and try again."
          );
        }
      }

      // Display agents in table
      function displayAgents(agentsData) {
        const tableBody = document.getElementById("agents-body");
        tableBody.innerHTML = "";

        if (agentsData.length === 0) {
          tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="noAgents">No agents found.</td>
            </tr>`;
          return;
        }

        agentsData.forEach((agent) => {
          const row = createAgentRow(agent);
          tableBody.appendChild(row);
        });
      }

      // Debounce helper (prevents filtering on every keystroke)
      function debounce(fn, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Search/filter logic
      function applySearchFilter() {
        const query = document
          .getElementById("search-input")
          .value.trim()
          .toLowerCase();

        if (!query) {
          displayAgents(agents);
          const totalCount = agents.length;
          const titleEl = document.getElementById("agents-title");
          const countEl = document.getElementById("agents-count");
          if (titleEl) titleEl.textContent = `${currentSystemName} Agents (${totalCount})`;
          if (countEl) countEl.textContent = `${totalCount} agents found`;
          return;
        }

        // Filter agents (current user is already excluded from the agents array)
        const filtered = agents.filter((a) => {
          const email = (a.email || "").toLowerCase();
          const company = (a.company_name || "").toLowerCase();
          const phone = (a.phone_number || "").toLowerCase();
          const fullName = `${a.first_name || ""} ${
            a.last_name || ""
          }`.toLowerCase();
          
          // Get the role name for the current system
          let roleName = "";
          if (a.system_roles && currentSystemSlug) {
            const systemRole = a.system_roles.find(role => role.system_slug === currentSystemSlug);
            roleName = systemRole ? systemRole.role_name.toLowerCase() : "";
          }

          return (
            email.includes(query) ||
            company.includes(query) ||
            phone.includes(query) ||
            fullName.includes(query) ||
            roleName.includes(query)
          );
        });

        displayAgents(filtered);
        const filteredCount = filtered.length;
        const titleEl = document.getElementById("agents-title");
        const countEl = document.getElementById("agents-count");
        if (titleEl) titleEl.textContent = `${currentSystemName} Agents (${filteredCount})`;
        if (countEl) countEl.textContent = `${filteredCount} agents found`;
      }

      const debouncedApplySearch = debounce(applySearchFilter, 250);

      // Attach listeners for search input and clear button
      const searchInput = document.getElementById("search-input");
      const clearButton = document.getElementById("clear-search");
      if (searchInput) {
        searchInput.addEventListener("input", debouncedApplySearch);
      }
      if (clearButton) {
        clearButton.addEventListener("click", function () {
          if (searchInput) searchInput.value = "";
          applySearchFilter();
        });
      }

      // Create table row for an agent
      function createAgentRow(agent) {
        const row = document.createElement("tr");
        // Ensure agent.id is a valid number
        const agentId = agent.id && !isNaN(agent.id) ? agent.id : null;
        
        if (!agentId) {
          console.error('Invalid agent ID in createAgentRow:', agent);
          return row; // Return empty row
        }
        
        // Find the agent's role in the current system to get system-specific is_active status
        let systemRoleActive = false;
        let systemRoleName = "N/A";
        if (agent.system_roles && currentSystemSlug) {
          const systemRole = agent.system_roles.find(role => role.system_slug === currentSystemSlug);
          if (systemRole) {
            systemRoleActive = systemRole.is_active;
            systemRoleName = systemRole.role_name;
          }
        }
        
        row.innerHTML = `
        <td>
            <img src="${
              agent.profile_picture ||
              "https://i.pinimg.com/1200x/a9/a8/c8/a9a8c8258957c8c7d6fcd320e9973203.jpg"
            }" 
                 alt="${agent.username}" 
                 class="agentAvatarSmall">
        </td>
        <td>${agent.first_name || ""} ${agent.last_name || ""}</td>
        <td>${agent.email}</td>
        <td>${systemRoleName}</td>
        <td>${agent.company_name || "N/A"}</td>
        <td>${agent.phone_number || "N/A"}</td>
        <td>
            <span class="agentStatus ${
              systemRoleActive ? "active" : "inactive"
            }">
                ${systemRoleActive ? "Active" : "Inactive"}
            </span>
        </td>
        <td>${
          agent.last_login
            ? new Date(agent.last_login).toLocaleDateString()
            : "Never"
        }</td>
        <td>
            <button onclick="viewAgent(${agentId})" class="btn btnSecondary btnSmall">View</button>
            <button onclick="editAgent(${agentId})" class="btn btnPrimary btnSmall">Edit</button>
        </td>
    `;
        return row;
      }

      // View agent details
      async function viewAgent(agentId) {
        // Validate agentId
        if (!agentId || agentId === 'null' || agentId === null || agentId === undefined) {
          console.error('Invalid agent ID:', agentId);
          showToast("Invalid agent ID", "error");
          return;
        }

        try {
          const response = await fetch(`/api/v1/users/${agentId}/`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const agent = await response.json();
          currentAgentId = parseInt(agentId, 10);

          // Find the agent's role in the current system to get system-specific is_active status
          let systemRoleActive = false;
          if (agent.system_roles && currentSystemSlug) {
            const systemRole = agent.system_roles.find(role => role.system_slug === currentSystemSlug);
            systemRoleActive = systemRole ? systemRole.is_active : false;
          }

          const detailsHtml = `
                    <div class="detailItem">
                        <label>Username:</label>
                        <span>${agent.username}</span>
                    </div>
                    <div class="detailItem">
                        <label>Email:</label>
                        <span>${agent.email}</span>
                    </div>
                    <div class="detailItem">
                        <label>First Name:</label>
                        <span>${agent.first_name || "N/A"}</span>
                    </div>
                    <div class="detailItem">
                        <label>Last Name:</label>
                        <span>${agent.last_name || "N/A"}</span>
                    </div>
                    <div class="detailItem">
                        <label>Phone:</label>
                        <span>${agent.phone_number || "N/A"}</span>
                    </div>
                    <div class="detailItem">
                        <label>Company:</label>
                        <span>${agent.company_name || "N/A"}</span>
                    </div>
                    <div class="detailItem">
                        <label>${currentSystemName} Status:</label>
                        <span class="agentStatus ${
                          systemRoleActive ? "active" : "inactive"
                        }">
                            ${systemRoleActive ? "Active" : "Inactive"}
                        </span>
                    </div>
                    <div class="detailItem">
                        <label>Date Joined:</label>
                        <span>${new Date(
                          agent.date_joined
                        ).toLocaleDateString()}</span>
                    </div>
                    <div class="detailItem">
                        <label>Last Login:</label>
                        <span>${
                          agent.last_login
                            ? new Date(agent.last_login).toLocaleDateString()
                            : "Never"
                        }</span>
                    </div>
                `;

          document.getElementById("agent-details").innerHTML = detailsHtml;
          document.getElementById("view-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Error loading agent details:", error);
          showToast("Failed to load agent details", "error");
        }
      }

      // Edit agent
      async function editAgent(agentId) {
        // Validate agentId
        if (!agentId || agentId === 'null' || agentId === null || agentId === undefined) {
          console.error('Invalid agent ID:', agentId);
          showToast("Invalid agent ID", "error");
          return;
        }

        try {
          const response = await fetch(`/api/v1/users/${agentId}/`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const agent = await response.json();
          currentAgentId = parseInt(agentId, 10);

          // Find the agent's role in the current system to get system-specific is_active status
          let systemRoleActive = false;
          let systemRoleId = null;
          if (agent.system_roles && currentSystemSlug) {
            const systemRole = agent.system_roles.find(role => role.system_slug === currentSystemSlug);
            if (systemRole) {
              systemRoleActive = systemRole.is_active;
              systemRoleId = systemRole.id;
            }
          }

          // Store the system role ID for the update request
          document.getElementById("edit-form").setAttribute("data-system-role-id", systemRoleId);

          // Populate form
          document.getElementById("edit-username").value = agent.username || "";
          document.getElementById("edit-email").value = agent.email || "";
          document.getElementById("edit-first-name").value =
            agent.first_name || "";
          document.getElementById("edit-last-name").value =
            agent.last_name || "";
          document.getElementById("edit-phone").value =
            agent.phone_number || "";
          document.getElementById("edit-company").value =
            agent.company_name || "";
          document.getElementById("edit-active").value = systemRoleActive
            ? "true"
            : "false";

          document.getElementById("edit-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Error loading agent for edit:", error);
          showToast("Failed to load agent data for editing", "error");
        }
      }

      // Edit from view modal
      function editFromView() {
        closeViewModal();
        editAgent(currentAgentId);
      }

      // Close modals
      function closeEditModal() {
        document.getElementById("edit-modal").classList.add("hidden");
        currentAgentId = null;
      }

      function closeViewModal() {
        document.getElementById("view-modal").classList.add("hidden");
        currentAgentId = null;
      }

      // Handle edit form submission
      document
        .getElementById("edit-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!currentAgentId || currentAgentId === 'null' || isNaN(currentAgentId)) {
            console.error('Invalid currentAgentId:', currentAgentId);
            showToast("Invalid agent ID for update", "error");
            return;
          }

          const formData = new FormData(this);
          const systemRoleId = this.getAttribute("data-system-role-id");
          
          // Only send fields that are allowed by AdminUserProfileUpdateSerializer
          const data = {
            first_name: formData.get("first_name"),
            last_name: formData.get("last_name"),
            phone_number: formData.get("phone_number"),
            system_role_is_active: formData.get("is_active") === "true",
            system_role_id: systemRoleId ? parseInt(systemRoleId, 10) : null
          };
          
          // Remove any fields that are empty or null to avoid sending unnecessary data
          Object.keys(data).forEach(key => {
            if (data[key] === null || data[key] === undefined || data[key] === '') {
              delete data[key];
            }
          });

          try {
            const response = await fetch(`/api/v1/users/${currentAgentId}/`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              credentials: "include",
              body: JSON.stringify(data),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Failed to update agent");
            }

            const updatedAgent = await response.json();
            showToast("Agent updated successfully", "success");
            closeEditModal();
            loadAgents(); // Refresh the list
          } catch (error) {
            console.error("Error updating agent:", error);
            showToast(error.message || "Failed to update agent", "error");
          }
        });

      // Close modals when clicking outside
      window.addEventListener("click", function (e) {
        const editModal = document.getElementById("edit-modal");
        const viewModal = document.getElementById("view-modal");

        if (e.target === editModal) {
          closeEditModal();
        }
        if (e.target === viewModal) {
          closeViewModal();
        }
      });

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        loadAgents();
      });
    </script>
  </body>
</html>
